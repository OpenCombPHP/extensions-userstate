<lib name="jquery"/>

<div class="newStateDisplayDiv" style="display:none">有<span class="newStateNumberSpan" updateTime=""></span>条新动态 <a href="javascript:;" onClick="loadNewStateHtml()">查看</a></div>
<hr/>
<div class="StateDiv">
<views/>
</div>

<hr/>
<a href="javascript:;" onClick="loadMoreStateHtml()">查看更多动态</a>

<script type="text/javascript">

function loadNewStateHtml(){
	jQuery.ajax({
	    type: "GET",
	    url: "/?c=org.opencomb.userstate.Index&rspn=view.noframe&limit="+jQuery(".newStateNumberSpan").html(),
	    dataType: "html",
	    success: function(html) {
	    	jQuery(".StateDiv").prepend(html);
	    	jQuery(".newStateNumberSpan").attr("updateTime",Date.parse(new Date())/1000);
	    	jQuery(".newStateDisplayDiv").hide();
	    }
	});
}

function loadMoreStateHtml(){
	jQuery.ajax({
	    type: "GET",
	    url: "/?c=org.opencomb.userstate.Index&rspn=view.noframe",
	    dataType: "html",
	    success: function(html) {
	    	jQuery(".StateDiv").append(html);
	    }
	});
}


function checkNewState(){
	
	var updateTime=jQuery(".newStateNumberSpan").attr("updateTime");
	if(updateTime == ""){
		jQuery(".newStateNumberSpan").attr("updateTime",Date.parse(new Date())/1000);
	}else{
		jQuery.ajax({
		    type: "GET",
		    url: "/?c=org.opencomb.userstate.NewStateNumber&time="+updateTime,
		    dataType: "html",
		    success: function(html) {
		    	if(html!="0"){
			    	jQuery(".newStateDisplayDiv").show();
			    	jQuery(".newStateNumberSpan").html(html);
		    	}else{
		    		jQuery(".newStateDisplayDiv").hide();
		    	}
		    }
		});
	}
}
window.setInterval("checkNewState()",3000);
</script>